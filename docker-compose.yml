name: chipsy-app

services:
  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    container_name: chipsy-bot
    restart: unless-stopped
    env_file:
      - .env
      - .env.production
    environment:
      NODE_ENV: production
      CHIPSY_ENV: ${CHIPSY_ENV:-production}
      INTERNAL_API_TOKEN: ${INTERNAL_API_TOKEN:?Set INTERNAL_API_TOKEN in .env}
      BOT_INTERNAL_PORT: ${BOT_INTERNAL_PORT:-7310}
      MYSQL_HOST: ${MYSQL_HOST:-infra-mysql}
    networks:
      db:
        aliases:
          - chipsy-bot
      edge:
        aliases:
          - chipsy-bot

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: chipsy-api
    restart: unless-stopped
    env_file:
      - .env
      - .env.production
    environment:
      NODE_ENV: production
      CHIPSY_ENV: ${CHIPSY_ENV:-production}
      PORT: ${PORT:-8082}
      MYSQL_HOST: ${MYSQL_HOST:-infra-mysql}
      BOT_RPC_BASE_URL: ${BOT_RPC_BASE_URL:-http://bot:7310/internal}
      BOT_RPC_TOKEN: ${BOT_RPC_TOKEN:-${INTERNAL_API_TOKEN}}
      SESSION_STORE: mysql
    networks:
      db:
        aliases:
          - chipsy-api
      edge:
        aliases:
          - chipsy-api
    depends_on:
      bot:
        condition: service_started

  panel:
    build:
      context: .
      dockerfile: panel/Dockerfile
      args:
        VUE_APP_DISCORD_CLIENT_ID: ${VUE_APP_DISCORD_CLIENT_ID:?Set VUE_APP_DISCORD_CLIENT_ID in .env}
    container_name: chipsy-panel
    restart: unless-stopped
    environment:
      NODE_ENV: production
    networks:
      edge:
        aliases:
          - chipsy-panel
    depends_on:
      api:
        condition: service_started

networks:
  db:
    external: true
    name: shared-db
  edge:
    external: true
    name: shared-edge
